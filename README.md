# WP Media Export

WordPress のメディアライブラリに保存されたファイル（画像・動画・音声・ドキュメント）を一括で ZIP ファイルとしてダウンロードできるプラグインです。

バッチ処理とプログレスバーにより、数千件規模のメディアファイルでもタイムアウトせずに安定して動作します。

---

## 主な機能

- **一括 ZIP ダウンロード** — 選択したメディアファイルをまとめて ZIP としてダウンロード
- **全件ダウンロード** — フィルタ条件に一致するすべてのメディアをワンクリックでダウンロード
- **バッチ処理** — 50 件ずつサーバーに送信するため、大量ファイルでもタイムアウトしない
- **プログレスバー** — リアルタイムで進捗状況を確認可能
- **フィルタ機能** — MIME タイプ（画像 / 動画 / 音声 / ドキュメント）や日付で絞り込み
- **検索** — ファイル名やタイトルでメディアを検索
- **オリジナルファイルのみ** — WordPress が自動生成するサムネイル・リサイズ画像は除外
- **ディレクトリ構造保持** — ZIP 内でアップロード時のフォルダ構造（年/月）を維持

## スクリーンショット

プラグイン有効化後、WordPress 管理画面の **メディア → メディアエクスポート** からアクセスできます。

| 機能 | 説明 |
|------|------|
| メディア一覧 | チェックボックス付きの一覧テーブル。サムネイル・タイトル・ファイル名・タイプ・日付・サイズを表示 |
| フィルタ | MIME タイプと日付（年月）で絞り込み |
| 選択をダウンロード | チェックしたファイルのみを ZIP ダウンロード |
| 全件ダウンロード | 現在のフィルタ条件に一致する全ファイルを ZIP ダウンロード |
| プログレスバー | バッチ処理の進捗をリアルタイム表示 |

---

## 動作要件

| 要件 | バージョン |
|------|-----------|
| WordPress | 5.8 以上 |
| PHP | 7.4 以上 |
| PHP 拡張 | ZipArchive（必須） |

> **Note:** ZipArchive が無効な環境ではプラグインの有効化時にエラーメッセージが表示されます。

---

## インストール

### WordPress 管理画面から

1. **プラグイン → 新規追加 → プラグインのアップロード** を選択
2. ダウンロードした `wp-media-export.zip` を選択してアップロード
3. **有効化** をクリック

### 手動インストール

1. ZIP ファイルを展開し、`wp_media_export` フォルダを `/wp-content/plugins/` にアップロード
2. WordPress 管理画面の **プラグイン** ページで **WP Media Export** を有効化

---

## 使い方

### 基本的な使い方

1. WordPress 管理画面で **メディア → メディアエクスポート** を開く
2. ダウンロードしたいメディアにチェックを入れる
3. **「選択をダウンロード」** ボタンをクリック
4. プログレスバーが進行し、完了すると ZIP ファイルのダウンロードが開始される

### 全件ダウンロード

1. 必要に応じてフィルタ（MIME タイプ・日付）で絞り込む
2. **「全件ダウンロード」** ボタンをクリック
3. 確認ダイアログで件数を確認し、OK をクリック
4. 自動的にバッチ処理が開始され、完了後に ZIP がダウンロードされる

### フィルタの使い方

- **MIME タイプ**: 「画像」「動画」「音声」「ドキュメント」から選択
- **日付**: アップロード年月で絞り込み
- **検索**: キーワードでタイトル・ファイル名を検索
- フィルタを設定したら **「フィルタ」** ボタンをクリックして適用

---

## ファイル構成

```
wp_media_export/
├── wp-media-export.php                  # メインプラグインファイル
├── uninstall.php                        # アンインストール時のクリーンアップ
├── readme.txt                           # WordPress.org 形式の readme
├── README.md                            # このファイル
├── includes/
│   ├── class-wp-media-export.php        # コアクラス（メニュー登録・アセット読込）
│   ├── class-media-list-table.php       # WP_List_Table 拡張（メディア一覧表示）
│   ├── class-zip-builder.php            # ZIP 作成サービス
│   └── class-ajax-handler.php           # AJAX エンドポイント
└── assets/
    ├── css/admin-style.css              # 管理画面 CSS
    └── js/admin-script.js               # バッチ処理・プログレスバー JS
```

---

## アーキテクチャ

### クラス構成

| クラス | 役割 |
|--------|------|
| `WP_Media_Export` | シングルトン。管理メニュー登録、CSS/JS 読込、管理画面レンダリング |
| `WPME_Media_List_Table` | `WP_List_Table` 拡張。チェックボックス付きメディア一覧、フィルタ、ページネーション |
| `WPME_Zip_Builder` | ディスク上に ZIP を構築。200 ファイルごとにアーカイブを再オープン |
| `WPME_Ajax_Handler` | 4 つの AJAX アクション: `start_export` → `add_batch` (×N) → `download` / `get_filtered_ids` |

### データフロー

```
[管理画面] ユーザーがメディアを選択 or 「全件ダウンロード」クリック
    ↓
[JS] wpme_start_export → サーバーが ZIP セッション (UUID トークン) 作成
    ↓
[JS] wpme_add_batch × N 回 (50 件ずつ) → プログレスバー更新
    ↓
[JS] wpme_download → hidden iframe で ZIP ストリーミングダウンロード
    ↓
[サーバー] 一時ファイル削除
```

---

## セキュリティ

| 脅威 | 対策 |
|------|------|
| CSRF | 全 AJAX リクエストに nonce チェック (`check_ajax_referer`) |
| 権限昇格 | `current_user_can('upload_files')` で投稿者以上のみアクセス可 |
| ディレクトリトラバーサル | `realpath()` でアップロードディレクトリ外のファイルを拒否 |
| トークン乗っ取り | UUID + transient + 単一使用（ダウンロード後に即削除） |
| 入力値汚染 | `absint()`, `sanitize_text_field()` で全入力をサニタイズ |
| 一時ファイル露出 | `wpme-tmp/` ディレクトリに `index.php` を配置してディレクトリリスティングを防止 |

---

## 大量ファイルへの対応

本プラグインは数千件規模のメディアファイルを想定して設計されています。

- **クエリ最適化**: ページネーション（50 件/ページ）、全選択時は `fields => 'ids'` で ID 配列のみ取得
- **バッチ AJAX**: 50 件ずつ送信してサーバーのタイムアウトを回避
- **ファイルハンドル管理**: 200 ファイルごとに `ZipArchive` を close/reopen して PHP のファイルハンドル上限を回避
- **ストリーミング**: 8 KB チャンクで ZIP を送信、出力バッファを全クリア
- **`max_input_vars` 対策**: ID を JSON 文字列として送信し、POST 変数数を最小限に抑制
- **自動クリーンアップ**: ダウンロード完了後に即削除、transient TTL 1 時間で放置ファイルも自動期限切れ

---

## トラブルシューティング

### 「ZipArchive が必要です」と表示される

サーバーに PHP の ZipArchive 拡張モジュールがインストールされていません。サーバー管理者またはホスティングプロバイダにお問い合わせください。

### プログレスバーが「準備中…」で止まる

- ブラウザの開発者ツール（F12）→ Console タブでエラーを確認してください
- サーバーのエラーログに PHP Fatal Error が記録されていないか確認してください
- ブラウザキャッシュをクリア（Ctrl+Shift+R / Cmd+Shift+R）してから再試行してください

### ダウンロードした ZIP が壊れている

- サーバーの PHP メモリ制限（`memory_limit`）が十分か確認してください
- サーバーのディスク空き容量が ZIP ファイルサイズ分あることを確認してください

### `max_input_vars` の警告が出る

本プラグインは ID を JSON 文字列で送信するため、通常この問題は発生しません。他のプラグインが原因の可能性があります。

---

## アンインストール

WordPress 管理画面の **プラグイン** ページから **WP Media Export** を削除すると、以下が自動的にクリーンアップされます:

- `wpme_export_*` transient（データベース）
- `wp-content/uploads/wpme-tmp/` 一時ディレクトリ

---

## 変更履歴

### 1.0.0

- 初回リリース
- メディア一覧テーブル（MIME タイプ・日付フィルタ、検索、ページネーション）
- バッチ処理による ZIP エクスポート（50 件ずつ AJAX 送信）
- プログレスバーによるリアルタイム進捗表示
- 全件ダウンロード機能
- セキュリティ対策（nonce、権限チェック、ディレクトリトラバーサル防止）

---

## ライセンス

[GPL-2.0-or-later](https://www.gnu.org/licenses/gpl-2.0.html)

---

## 免責事項

本プラグインは現状有姿（AS IS）で提供されます。作者は、本プラグインの使用または使用不能に起因するいかなる損害（データの喪失、サーバー障害、事業の中断、その他一切の直接的・間接的・偶発的・特別・懲罰的損害を含みますがこれらに限りません）についても、一切の責任を負いません。

本プラグインを使用する前に、以下の点にご留意ください:

- **バックアップの実施**: プラグインの導入前に、WordPress のファイルおよびデータベースの完全なバックアップを取得してください。
- **テスト環境での検証**: 本番環境に導入する前に、ステージング環境またはテスト環境で動作を確認することを強く推奨します。
- **サーバーリソース**: 大量のメディアファイルをエクスポートする場合、サーバーの CPU・メモリ・ディスク容量に十分な余裕があることを確認してください。一時ファイルとして ZIP が生成されるため、エクスポート対象のファイル合計サイズと同程度のディスク空き容量が必要です。
- **自己責任での使用**: 本プラグインの使用はすべてユーザー自身の責任において行ってください。
- **保証の否認**: 作者は、本プラグインの正確性、信頼性、完全性、適時性、特定目的への適合性について、明示または黙示を問わず、いかなる保証も行いません。
- **サポート**: 本プラグインに対する技術サポートの義務は負いません。GitHub Issues を通じたバグ報告は歓迎しますが、対応を保証するものではありません。
